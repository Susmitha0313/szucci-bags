<%- include("../partials/header.ejs") %>

<div class="breadcrumb-area section-padding-1 bg-gray breadcrumb-ptb-1">
    <div class="container-fluid">
        <div class="breadcrumb-content text-center">
            <div class="breadcrumb-title">
                <h2>Order Details</h2>
            </div>
            <ul>
                <li>
                    <a href="/">home </a>
                </li>
                <li><span> &gt; </span></li>
                <li class="active"> Shopping Cart </li>
            </ul>
        </div>
    </div>
</div>
<!-- cart start -->
<div class="cart-main-area pt-90 pb-100">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-12">
                        <div class="col-lg-8">
                            <div class="table-content table-responsive cart-table-content">
                                <table>
                                    
                                    <thead>
                                        <tr style="text-align: center;">
                                            <th>Image</th>
                                            <th style="width: 70px;">Product</th>
                                            <th> Price</th>
                                            <th>Quantity</th>
                                            <th>total</th>
                                            <th style="width: 150px;">Status</th>
                                           
                                        </tr>
                                    </thead>
                                    <tbody style="text-align: center;">
                                        <% orderData.forEach(element=>{ %> 
                                            <% element.items.forEach(item => { %>
                                        <tr>
                                            <td class="product-img">
                                                <% if(item.productId.productImage[0] !== undefined && item.productId.productImage[0] !== ''){ %>
                                                <a href="#"><img style="height: 100px;" src="/assets/adminAssets/imgUploads/<%= item.productId.productImage[0] %>" alt="image"></a>
                                                <% }else { %>
                                                <a href="#"><img style="height: 100px;" src="/assets/adminAssets/imgs/icons/szucci-favicon-black.png" alt="image"></a>
                                                <% } %>
                                            </td>
                                            <td class="product-name"><a href="/product-details?:id="<%=item.productId._id %>><%= item.productId.productName %></a></td>
                                            <td class="product-price"><span class="amount">₹ <%= item.productId.salePrice %></span></td>
                                            <td class="cart-quality"><span class="amount"><%= item.quantity %></span></td>
                                            
                                              
                                            </td>
                                            <td class="product-total"><span>₹ <%= item.subTotal %></span></td>
                                            <td class="product-status"><span> <%= element.status %></span></td>
                                        </tr>
                                        <% }) %>
                                        <% }) %>
                                    </tbody>
                                </table>
                            </div>
            
                            
                        </div>
                        <% orderData.forEach(element=>{ %> 
                            <% if(element.status == "Cancelled"){ %> 
                                <p>Order is Cancelled</p>
                            <% } else { %>
                        <div>
                            <button onclick="CancelButton(' <%= element._id %> ')"   id="cancelButton">Cancel Order</button>
                        </div>
                           <% } %>
                        <% }) %>


                        <!-- <div class="col-lg-4">
                            <div class="grand-total-wrap">
                                <% orderData.forEach(element=>{ %> 
                                <div class="grand-total-content">
                                    <ul>
                                        <li >Subtotal  <span>₹ <%=element.totalAmount  %></span> </li>
                                        <li>Total <span>₹ <%=element.totalAmount  %></span> </li>
                                    </ul>
                                </div>
                                <% }) %>
                                <div class="grand-btn">
                                    <a href="#">Download Invoice</a>
                                </div>
                            </div>
                        </div> -->
                    </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function CancelButton(id) {
    alert("canceling"+ id);
    Swal.fire({
        title: 'Are You Sure You Want to Cancel the Order?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'OK',
        cancelButtonText: 'Cancel'
    }).then(async (result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Reason for Cancelling',
                html: '<input id="cancelationReason" class="swal2-input" placeholder="Reason for cancellation">',
                icon: 'warning',
                confirmButtonText: 'Submit',
                preConfirm: () => {
                    const cancellationReason = document.getElementById('cancelationReason').value;
                    if (!cancellationReason) {
                        Swal.showValidationMessage('Cancellation reason cannot be empty');
                    } else if(!isNaN(cancellationReason)) {
                        Swal.showValidationMessage('Cancellation reason must be a string');
                    }
                    // Add more validation logic here if needed
                    return cancellationReason;
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const cancellationReason = result.value; // Retrieve cancellation reason entered by the user
                    try {
                        const response = await fetch('/orderCancel/' + id, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                reason: cancellationReason
                            })
                        });
                        const data = await response.json();
                        console.log(response);
                        if (data.success) {
                            Swal.fire('Success', data.message, 'success');
                            location.reload();
                        } else {
                            Swal.fire('Error', data.message, 'error');
                            console.error('Item not canceled');
                        }
                    } catch (error) {
                        Swal.fire('Error', 'Failed to cancel order', 'error');
                        console.log('Fetch Error:', error);
                    }
                }
            });
        } else {
            // Handle cancellation by the user
            console.log('Action canceled by the user');
        }
    });
}

</script>
<%- include("../partials/footer.ejs") %>
      

